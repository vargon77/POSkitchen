# views/caja/caja_screen.kv - L√çNEA 255 CORREGIDA
<CajaScreen>:
    name: "caja"
    
    ResponsiveBoxLayout:
        orientation: "vertical"
        responsive_spacing: "none"
        responsive_padding: "none"

        # ========== TOP BAR ==========
        MDTopAppBar:
            title: "üí∞ M√≥dulo de Caja"
            md_bg_color: ds_color('primary')
            elevation: 2
            left_action_items: [["arrow-left", root.ir_a_menu]]
            right_action_items: [["history", root.ver_historial_cierres], ["refresh", root.forzar_actualizacion]]

        # ========== ESTADO CAJA Y CONTROLES ==========
        ResponsiveCard:
            orientation: "horizontal"
            size_hint_y: None
            height: dp(80)
            padding: ds_spacing('md')
            spacing: ds_spacing('md')
            elevation: 2
            md_bg_color: ds_color('light')

            # Estado actual
            ResponsiveBoxLayout:
                orientation: "vertical"
                size_hint_x: 0.4
                spacing: dp(4)
                
                MDLabel:
                    text: "ESTADO DE CAJA"
                    font_style: "Caption"
                    theme_text_color: "Secondary"
                    size_hint_y: 0.4
                
                MDLabel:
                    id: label_estado_caja
                    text: root.estado_caja
                    font_style: "H6"
                    bold: True
                    theme_text_color: "Custom"
                    text_color: ds_color('success') if root.caja_abierta else ds_color('error')
                    size_hint_y: 0.6

            # Botones control
            ResponsiveBoxLayout:
                orientation: "horizontal"
                size_hint_x: 0.6
                responsive_spacing: "xs"

                ResponsiveMDRaisedButton:
                    id: btn_abrir_caja
                    text: "ABRIR CAJA"
                    icon: "lock-open"
                    disabled: root.caja_abierta
                    md_bg_color: ds_color('success')
                    on_release: root.abrir_caja()

                ResponsiveMDRaisedButton:
                    id: btn_cerrar_caja
                    text: "CERRAR CAJA"
                    icon: "lock"
                    disabled: not root.caja_abierta
                    md_bg_color: ds_color('error')
                    on_release: root.cerrar_caja()

                ResponsiveMDRaisedButton:
                    text: "ARQUEO"
                    icon: "cash-multiple"
                    disabled: not root.caja_abierta
                    md_bg_color: ds_color('warning')
                    on_release: root.realizar_arqueo()

        # ========== ESTAD√çSTICAS DEL D√çA ==========
        ResponsiveCard:
            orientation: "vertical"
            size_hint_y: None
            height: dp(100)
            padding: ds_spacing('md')
            spacing: ds_spacing('sm')
            elevation: 1
            md_bg_color: ds_color('white')

            MDLabel:
                text: "üìä RESUMEN DEL D√çA"
                font_style: "Subtitle1"
                bold: True
                size_hint_y: None
                height: dp(25)

            ResponsiveGridLayout:
                cols: 4
                spacing: ds_spacing('sm')
                size_hint_y: None
                height: dp(60)

                # Total ventas
                EstadisticaCard:
                    titulo: "Total Ventas"
                    valor: f"${root.total_ventas:.2f}"
                    icono: "üí∞"
                    color_fondo: ds_color('success', 0.1)

                # Efectivo
                EstadisticaCard:
                    titulo: "Efectivo"
                    valor: f"${root.total_efectivo:.2f}"
                    icono: "üíµ"
                    color_fondo: ds_color('warning', 0.1)

                # Tarjeta
                EstadisticaCard:
                    titulo: "Tarjeta"
                    valor: f"${root.total_tarjeta:.2f}"
                    icono: "üí≥"
                    color_fondo: ds_color('info', 0.1)

                # Transferencia
                EstadisticaCard:
                    titulo: "Transfer"
                    valor: f"${root.total_transferencia:.2f}"
                    icono: "üì±"
                    color_fondo: ds_color('secondary', 0.1)

        # ========== SECCI√ìN PEDIDOS PENDIENTES ==========
        ResponsiveBoxLayout:
            orientation: "vertical"
            spacing: dp(8)

            # Header con tabs
            ResponsiveBoxLayout:
                orientation: "horizontal"
                size_hint_y: None
                height: dp(48)
                padding: [ds_spacing('md'), 0]
                responsive_spacing: "sm"
                
                canvas.before:
                    Color:
                        rgba: ds_color('light')
                    Rectangle:
                        pos: self.pos
                        size: self.size

                MDLabel:
                    text: "PEDIDOS LISTOS PARA PAGAR"
                    font_style: "Subtitle1"
                    bold: True
                    size_hint_x: 0.6

                ResponsiveChip:
                    id: chip_todos_pedidos
                    text: "TODOS"
                    selected: True
                    on_press: root.filtrar_pedidos('todos')

                ResponsiveChip:
                    id: chip_listos
                    text: "LISTOS"
                    on_press: root.filtrar_pedidos('listo')

                MDLabel:
                    id: label_count_pedidos
                    text: f"{len(root.pedidos_pendientes)} pedidos"
                    font_style: "Caption"
                    theme_text_color: "Secondary"
                    size_hint_x: 0.2
                    halign: "right"

            # Grid de pedidos
            ResponsiveScrollView:
                do_scroll_x: False
                bar_width: dp(4)
                bar_color: ds_color('primary', 0.3)

                ResponsiveGridLayout:
                    id: contenedor_pedidos
                    default_cols: 2
                    spacing: ds_spacing('md')
                    padding: ds_spacing('md')
                    size_hint_y: None
                    height: self.minimum_height


# ========== WIDGET: TARJETA ESTAD√çSTICA ==========
<EstadisticaCard>:
    orientation: "vertical"
    padding: ds_spacing('sm')
    spacing: dp(4)
    elevation: 0
    radius: dp(8)
    md_bg_color: root.color_fondo
    
    MDLabel:
        text: root.icono
        font_size: sp(20)
        halign: "left"
        size_hint_y: 0.3
    
    MDLabel:
        text: root.titulo
        font_style: "Caption"
        theme_text_color: "Secondary"
        size_hint_y: 0.3
    
    MDLabel:
        text: root.valor
        font_style: "Subtitle1"
        bold: True
        theme_text_color: "Primary"
        size_hint_y: 0.4


# ========== WIDGET: CARD DE PEDIDO PARA PAGO ==========
<PedidoPagoCard>:
    orientation: "vertical"
    size_hint_y: None
    height: dp(200)
    padding: 0
    spacing: 0
    elevation: 2
    radius: dp(12)
    md_bg_color: ds_color('white')
    
    # Header
    ResponsiveBoxLayout:
        orientation: "horizontal"
        size_hint_y: None
        height: dp(60)
        responsive_padding: "sm"
        responsive_spacing: "sm"
        
        canvas.before:
            Color:
                rgba: ds_color('primary', 0.1)
            Rectangle:
                pos: self.pos
                size: self.size
        
        ResponsiveBoxLayout:
            orientation: "vertical"
            size_hint_x: 0.6
            
            MDLabel:
                text: f"PEDIDO #{root.pedido_id}"
                font_style: "H6"
                bold: True
                theme_text_color: "Primary"
                size_hint_y: 0.6
            
            # ‚úÖ L√çNEA 255 CORREGIDA - INDENTACI√ìN
            MDLabel:
                text: f"Mesa {root.mesa} - {root.num_items} items"
                font_style: "Caption"
                theme_text_color: "Secondary"
                size_hint_y: 0.4
        
        MDLabel:
            text: f"${root.total:.2f}"
            font_style: "H5"
            bold: True
            size_hint_x: 0.4
            halign: "right"
            theme_text_color: "Custom"
            text_color: ds_color('success')
    
    ResponsiveSeparator:
        height: dp(1)
    
    # Info mesero y tiempo
    ResponsiveBoxLayout:
        orientation: "horizontal"
        size_hint_y: None
        height: dp(30)
        padding: [ds_spacing('sm'), dp(4)]
        
        MDLabel:
            text: f"Mesero: {root.mesero}"
            font_style: "Caption"
            theme_text_color: "Secondary"
            size_hint_x: 0.6
        
        MDLabel:
            text: root.tiempo
            font_style: "Caption"
            theme_text_color: "Hint"
            size_hint_x: 0.4
            halign: "right"
    
    ResponsiveSeparator:
        height: dp(1)
    
    # Botones de pago
    ResponsiveBoxLayout:
        orientation: "horizontal"
        size_hint_y: None
        height: dp(90)
        spacing: dp(4)
        padding: ds_spacing('sm')
        
        ResponsiveBoxLayout:
            orientation: "vertical"
            spacing: dp(4)
            
            ResponsiveMDRaisedButton:
                text: "EFECTIVO"
                icon: "cash"
                md_bg_color: ds_color('success')
                size_hint_y: 0.5
                on_release: root.pagar_efectivo()
            
            ResponsiveMDRaisedButton:
                text: "TARJETA"
                icon: "credit-card"
                md_bg_color: ds_color('info')
                size_hint_y: 0.5
                on_release: root.pagar_tarjeta()
        
        ResponsiveBoxLayout:
            orientation: "vertical"
            spacing: dp(4)
            
            ResponsiveMDRaisedButton:
                text: "TRANSFER"
                icon: "bank-transfer"
                md_bg_color: ds_color('secondary')
                size_hint_y: 0.5
                on_release: root.pagar_transferencia()
            
            MDFlatButton:
                text: "VER DETALLE"
                icon: "eye"
                size_hint_y: 0.5
                on_release: root.ver_detalle()


# ========== ESTADO VAC√çO ==========
<CajaEmptyState>:
    orientation: "vertical"
    padding: dp(40)
    spacing: dp(20)
    
    MDLabel:
        text: "üí∞"
        font_size: sp(64)
        halign: "center"
        size_hint_y: None
        height: dp(80)
    
    MDLabel:
        text: "Sin pedidos pendientes de pago"
        font_style: "H6"
        halign: "center"
        theme_text_color: "Secondary"
        size_hint_y: None
        height: dp(40)
    
    MDLabel:
        text: "Los pedidos listos aparecer√°n aqu√≠"
        font_style: "Body2"
        halign: "center"
        theme_text_color: "Hint"