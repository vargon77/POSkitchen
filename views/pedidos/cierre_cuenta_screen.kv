# views/pedidos/cierre_cuenta_screen.kv - COMPLETO CORREGIDO
<CierreCuentaScreen>:
    name: "cierre_cuenta"
    
    ResponsiveBoxLayout:
        orientation: "vertical"
        responsive_spacing: "none"
        responsive_padding: "none"

        # ========== TOP BAR ==========
        MDTopAppBar:
            title: f"Cierre - Mesa {root.mesa_seleccionada if root.mesa_seleccionada else '...'}"
            md_bg_color: ds_color('primary')
            elevation: 2
            left_action_items: [["arrow-left", root.volver_al_menu]]
            right_action_items: [["refresh", root.refrescar_datos], ["receipt", root.ver_tickets_generados]]

        # ========== SELECTOR MESA ==========
        ResponsiveCard:
            orientation: "horizontal"
            size_hint_y: None
            height: dp(56)
            padding: ds_spacing('md')
            spacing: ds_spacing('md')
            elevation: 1
            md_bg_color: ds_color('light')

            MDLabel:
                text: "Mesa:"
                font_style: "Subtitle1"
                bold: True
                size_hint_x: None
                width: dp(60)

            ResponsiveSpinner:
                id: selector_mesa
                text: "Seleccionar"
                values: root.mesas_disponibles
                size_hint_x: 1
                on_text: root.cargar_pedidos_mesa(self.text)

            MDLabel:
                id: info_mesa_rapida
                text: ""
                font_style: "Caption"
                theme_text_color: "Secondary"
                size_hint_x: 0.4
                halign: "right"

        # ========== CONTENIDO PRINCIPAL ==========
        ResponsiveBoxLayout:
            orientation: "horizontal" if not ds_is_mobile() else "vertical"
            responsive_spacing: "xs"

            # ===== LISTA DE PEDIDOS (30%) =====
            ResponsiveCard:
                orientation: "vertical"
                size_hint_x: 0.3 if not ds_is_mobile() else 1
                size_hint_y: 0.3 if ds_is_mobile() else 1
                elevation: 2
                padding: 0

                # Header
                ResponsiveBoxLayout:
                    orientation: "horizontal"
                    size_hint_y: None
                    height: dp(44)
                    responsive_padding: "sm"
                    
                    canvas.before:
                        Color:
                            rgba: ds_color('secondary', 0.1)
                        Rectangle:
                            pos: self.pos
                            size: self.size

                    MDLabel:
                        text: "PEDIDOS"
                        font_style: "Subtitle1"
                        bold: True
                        size_hint_x: 0.6

                    MDLabel:
                        id: label_count_pedidos
                        text: f"{len(root.pedidos_mesa)} pedidos"
                        font_style: "Caption"
                        theme_text_color: "Secondary"
                        size_hint_x: 0.4
                        halign: "right"

                # Lista scrollable
                ResponsiveScrollView:
                    do_scroll_x: False
                    bar_width: dp(3)

                    ResponsiveBoxLayout:
                        id: lista_pedidos
                        orientation: "vertical"
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(2)
                        padding: ds_spacing('xs')

            # ===== DETALLE Y ACCIONES (70%) =====
            ResponsiveCard:
                orientation: "vertical"
                size_hint_x: 0.7 if not ds_is_mobile() else 1
                size_hint_y: 0.7 if ds_is_mobile() else 1
                elevation: 2
                padding: 0
                spacing: 0

                # --- Header Pedido ---
                ResponsiveBoxLayout:
                    orientation: "horizontal"
                    size_hint_y: None
                    height: dp(56)
                    responsive_padding: "md"
                    responsive_spacing: "sm"
                    
                    canvas.before:
                        Color:
                            rgba: ds_color('primary')
                        Rectangle:
                            pos: self.pos
                            size: self.size

                    MDLabel:
                        id: label_pedido_info
                        text: "Seleccione un pedido"
                        font_style: "H6"
                        theme_text_color: "Custom"
                        text_color: ds_color('white')
                        bold: True
                        size_hint_x: 0.5

                    MDLabel:
                        id: label_total_pedido
                        text: "$0.00"
                        font_style: "H6"
                        theme_text_color: "Custom"
                        text_color: ds_color('white')
                        bold: True
                        size_hint_x: 0.3
                        halign: "right"

                    ResponsiveMDRaisedButton:
                        id: btn_pagar_completo
                        text: "PAGAR"
                        icon: "cash-check"
                        size_hint_x: 0.2
                        disabled: True
                        md_bg_color: ds_color('success')
                        on_release: root.pagar_pedido_completo()

                # --- Tabla Items ---
                ResponsiveBoxLayout:
                    orientation: "vertical"
                    spacing: 0

                    # Header tabla
                    ResponsiveBoxLayout:
                        orientation: "horizontal"
                        size_hint_y: None
                        height: dp(36)
                        padding: [ds_spacing('sm'), dp(4)]
                        
                        canvas.before:
                            Color:
                                rgba: ds_color('gray_light')
                            Rectangle:
                                pos: self.pos
                                size: self.size

                        MDLabel:
                            text: "Producto"
                            font_style: "Caption"
                            bold: True
                            size_hint_x: 0.5

                        MDLabel:
                            text: "Cant."
                            font_style: "Caption"
                            bold: True
                            size_hint_x: 0.15
                            halign: "center"

                        MDLabel:
                            text: "Precio"
                            font_style: "Caption"
                            bold: True
                            size_hint_x: 0.2
                            halign: "right"

                        MDLabel:
                            text: "Subtotal"
                            font_style: "Caption"
                            bold: True
                            size_hint_x: 0.15
                            halign: "right"

                    # Contenido scrollable
                    ResponsiveScrollView:
                        do_scroll_x: False
                        bar_width: dp(3)

                        ResponsiveBoxLayout:
                            id: detalle_items
                            orientation: "vertical"
                            size_hint_y: None
                            height: self.minimum_height
                            spacing: dp(1)

                # --- Panel MÃ©todos Pago ---
                ResponsiveCard:
                    orientation: "vertical"
                    size_hint_y: None
                    height: dp(100)
                    padding: ds_spacing('md')
                    spacing: ds_spacing('sm')
                    md_bg_color: ds_color('light')
                    elevation: 0

                    MDLabel:
                        text: "MÃ‰TODO DE PAGO"
                        font_style: "Caption"
                        bold: True
                        size_hint_y: None
                        height: dp(20)

                    ResponsiveBoxLayout:
                        orientation: "horizontal"
                        responsive_spacing: "xs"

                        ResponsiveChip:
                            id: chip_efectivo
                            text: "ðŸ’µ Efectivo"
                            on_press: root.seleccionar_metodo('efectivo')

                        ResponsiveChip:
                            id: chip_tarjeta
                            text: "ðŸ’³ Tarjeta"
                            on_press: root.seleccionar_metodo('tarjeta')

                        ResponsiveChip:
                            id: chip_transfer
                            text: "ðŸ“± Transfer"
                            on_press: root.seleccionar_metodo('transferencia')

                # --- Footer: Total y Confirmar ---
                ResponsiveBoxLayout:
                    orientation: "horizontal"
                    size_hint_y: None
                    height: dp(70)
                    responsive_padding: "md"
                    responsive_spacing: "md"
                    
                    canvas.before:
                        Color:
                            rgba: ds_color('success', 0.05)
                        Rectangle:
                            pos: self.pos
                            size: self.size

                    ResponsiveBoxLayout:
                        orientation: "vertical"
                        size_hint_x: 0.4
                        spacing: dp(2)

                        MDLabel:
                            text: "TOTAL A PAGAR"
                            font_style: "Caption"
                            theme_text_color: "Secondary"
                            size_hint_y: None
                            height: dp(18)

                        MDLabel:
                            id: label_total_final
                            text: "$0.00"
                            font_style: "H5"
                            bold: True
                            theme_text_color: "Custom"
                            text_color: ds_color('success')

                    ResponsiveBoxLayout:
                        orientation: "horizontal"
                        size_hint_x: 0.6
                        responsive_spacing: "sm"

                        MDFlatButton:
                            text: "DESCUENTO"
                            icon: "sale"
                            on_release: root.aplicar_descuento()

                        ResponsiveMDRaisedButton:
                            id: btn_confirmar_pago
                            text: "CONFIRMAR PAGO"
                            icon: "check-bold"
                            disabled: True
                            md_bg_color: ds_color('success')
                            on_release: root.procesar_pago_final()


# ========== WIDGET: ITEM PEDIDO COMPACTO ==========
<PedidoItemCompact>:
    orientation: "vertical"
    size_hint_y: None
    height: dp(68)
    padding: ds_spacing('sm')
    spacing: dp(4)
    radius: dp(8)
    elevation: 1
    ripple_behavior: True
    md_bg_color: ds_color('white')
    
    ResponsiveBoxLayout:
        orientation: "horizontal"
        responsive_spacing: "sm"
        
        MDLabel:
            text: f"#{root.pedido_id}"
            font_style: "H6"
            bold: True
            size_hint_x: 0.2
            theme_text_color: "Primary"
        
        ResponsiveBoxLayout:
            orientation: "vertical"
            size_hint_x: 0.5
            spacing: dp(2)
            
            MDLabel:
                text: f"{root.num_items} items"
                font_style: "Caption"
                theme_text_color: "Secondary"
            
            MDLabel:
                text: root.pedido_estado.upper()
                font_style: "Caption"
                theme_text_color: "Primary"
                bold: True
        
        MDLabel:
            text: f"${root.pedido_total:.2f}"
            font_style: "Subtitle1"
            bold: True
            size_hint_x: 0.3
            halign: "right"
            theme_text_color: "Custom"
            text_color: ds_color('success')


# ========== WIDGET: FILA ITEM TABLA ==========
<ItemFilaTabla>:
    orientation: "horizontal"
    size_hint_y: None
    height: dp(44)
    padding: [ds_spacing('sm'), dp(6)]
    spacing: dp(4)
    
    canvas.before:
        Color:
            rgba: ds_color('white') if self.parent and self.parent.children.index(self) % 2 == 0 else ds_color('light')
        Rectangle:
            pos: self.pos
            size: self.size
    
    MDLabel:
        text: root.item_nombre
        font_style: "Body2"
        size_hint_x: 0.5
        shorten: True
        shorten_from: "right"
    
    MDLabel:
        text: str(root.item_cantidad)
        font_style: "Body2"
        size_hint_x: 0.15
        halign: "center"
    
    MDLabel:
        text: f"${root.item_precio:.2f}"
        font_style: "Body2"
        size_hint_x: 0.2
        halign: "right"
    
    MDLabel:
        text: f"${root.item_subtotal:.2f}"
        font_style: "Subtitle2"
        bold: True
        size_hint_x: 0.15
        halign: "right"
        theme_text_color: "Custom"
        text_color: ds_color('success')