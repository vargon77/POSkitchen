# views/pedidos/toma_pedidos_screen.kv - CORREGIDO
<TomaPedidoScreen>:
    name: "pedidos"
    
    ResponsiveBoxLayout:
        orientation: "vertical"
        responsive_spacing: "none"
        responsive_padding: "none"

        # ========== TOP BAR ==========
        MDTopAppBar:
            title: f"Tomar Pedido - Mesa {root.mesa_actual}"
            md_bg_color: ds_color('primary')
            elevation: 2
            left_action_items: [["arrow-left", root.ir_a_menu]]
            right_action_items: [["swap-horizontal", root.cambiar_mesa], ["delete-sweep", root.limpiar_pedido]]

        # ========== CONTENIDO PRINCIPAL ==========
        ResponsiveBoxLayout:
            orientation: "horizontal" if not ds_is_mobile() else "vertical"
            responsive_spacing: "xs"

            # ===== PANEL IZQUIERDO: PRODUCTOS (70%) =====
            ResponsiveCard:
                orientation: "vertical"
                size_hint_x: 0.7 if not ds_is_mobile() else 1
                size_hint_y: 0.6 if ds_is_mobile() else 1
                elevation: 2
                padding: 0
                spacing: 0
                md_bg_color: ds_color('white')

                # --- Chips de Categor√≠as ---
                ResponsiveCard:
                    orientation: "vertical"
                    size_hint_y: None
                    height: dp(64)
                    elevation: 0
                    padding: [ds_spacing('sm'), dp(8)]
                    md_bg_color: ds_color('secondary', 0.05)
                    
                    ResponsiveScrollView:
                        do_scroll_y: False
                        bar_width: 0
                        
                        ResponsiveBoxLayout:
                            id: contenedor_categorias
                            orientation: "horizontal"
                            adaptive_width: True
                            responsive_spacing: "sm"
                            padding: [ds_spacing('xs'), 0]

                # --- Grid de Productos ---
                ResponsiveScrollView:
                    do_scroll_x: False
                    bar_width: dp(4)
                    bar_color: ds_color('primary', 0.3)
                    
                    ResponsiveGridLayout:
                        id: grid_productos
                        default_cols: 3
                        spacing: ds_spacing('md')
                        padding: ds_spacing('md')
                        adaptive_height: True
                        size_hint_y: None
                        height: self.minimum_height

            # ===== PANEL DERECHO: RESUMEN PEDIDO (30%) =====
            ResponsiveCard:
                orientation: "vertical"
                size_hint_x: 0.3 if not ds_is_mobile() else 1
                size_hint_y: 0.4 if ds_is_mobile() else 1
                elevation: 2
                padding: 0
                spacing: 0
                md_bg_color: ds_color('white')

                # --- Header Pedido ---
                ResponsiveBoxLayout:
                    orientation: "horizontal"
                    size_hint_y: None
                    height: dp(56)
                    responsive_padding: "md"
                    responsive_spacing: "sm"
                    
                    canvas.before:
                        Color:
                            rgba: ds_color('secondary')
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    
                    MDLabel:
                        text: "PEDIDO ACTUAL"
                        font_style: "H6"
                        theme_text_color: "Custom"
                        text_color: ds_color('white')
                        bold: True
                        size_hint_x: 0.6
                    
                    MDLabel:
                        id: label_items_count
                        text: "0 items"
                        font_style: "Caption"
                        theme_text_color: "Custom"
                        text_color: ds_color('white')
                        size_hint_x: 0.4
                        halign: "right"

                # --- Lista de Items ---
                ResponsiveScrollView:
                    do_scroll_x: False
                    bar_width: dp(3)
                    bar_color: ds_color('primary', 0.3)
                    
                    ResponsiveBoxLayout:
                        id: lista_items
                        orientation: "vertical"
                        adaptive_height: True
                        responsive_spacing: "xs"
                        responsive_padding: "sm"
                        size_hint_y: None
                        height: self.minimum_height

                # --- Footer: Total y Botones ---
                ResponsiveBoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: dp(140)
                    responsive_padding: "md"
                    responsive_spacing: "sm"
                    
                    canvas.before:
                        Color:
                            rgba: ds_color('success', 0.05)
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    
                    # Total
                    ResponsiveBoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(60)
                        spacing: dp(4)
                        
                        MDLabel:
                            text: "TOTAL"
                            font_style: "Caption"
                            theme_text_color: "Secondary"
                            size_hint_y: None
                            height: dp(18)
                        
                        MDLabel:
                            text: f"${root.total_pedido:.2f}"
                            font_style: "H4"
                            bold: True
                            theme_text_color: "Custom"
                            text_color: ds_color('success')
                            size_hint_y: None
                            height: dp(42)
                    
                    # Bot√≥n Confirmar
                    ResponsiveMDRaisedButton:
                        text: "CONFIRMAR PEDIDO"
                        icon: "check-bold"
                        button_size: "lg"
                        md_bg_color: ds_color('success')
                        on_release: root.confirmar_pedido()
                        disabled: root.total_pedido == 0


# ========== WIDGET: CHIP DE CATEGOR√çA ==========
<CategoryChipPro>:
    size_hint: (None, None)
    height: dp(36)
    radius: dp(18)
    
    canvas.before:
        Color:
            rgba: ds_color('primary') if root.selected else ds_color('gray_light')
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(18)]
    
    MDLabel:
        text: root.text
        font_style: "Button"
        theme_text_color: "Custom"
        text_color: ds_color('white') if root.selected else ds_color('dark')
        bold: root.selected
        halign: "center"
        valign: "middle"


# ========== WIDGET: CARD DE PRODUCTO ==========
<ProductCardPro>:
    orientation: "vertical"
    size_hint: (None, None)
    size: (dp(140), dp(160))
    padding: dp(10)
    spacing: dp(6)
    elevation: 2
    radius: dp(12)
    ripple_behavior: True
    md_bg_color: ds_color('white')
    
    canvas.before:
        Color:
            rgba: ds_color('primary', 0.05)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(12)]
    
    # Emoji/Icono
    MDLabel:
        text: "üçΩÔ∏è"
        font_size: sp(40)
        halign: "center"
        size_hint_y: 0.4
    
    # Nombre
    MDLabel:
        text: root.producto_nombre
        font_style: "Body2"
        bold: True
        halign: "center"
        size_hint_y: 0.3
        shorten: True
        shorten_from: "right"
        theme_text_color: "Primary"
    
    # Precio
    MDLabel:
        text: f"${root.producto_precio:.2f}"
        font_style: "H6"
        bold: True
        halign: "center"
        size_hint_y: 0.3
        theme_text_color: "Custom"
        text_color: ds_color('success')


# ========== WIDGET: ITEM DE PEDIDO ==========
<OrderItemPro>:
    orientation: "horizontal"
    size_hint_y: None
    height: dp(70)
    padding: dp(10)
    spacing: dp(8)
    elevation: 1
    radius: dp(10)
    md_bg_color: ds_color('white')
    
    ResponsiveBoxLayout:
        orientation: "horizontal"
        responsive_spacing: "sm"
        
        # Nombre
        MDLabel:
            text: root.item_nombre
            font_style: "Body2"
            size_hint_x: 0.45
            shorten: True
            shorten_from: "right"
            theme_text_color: "Primary"
            valign: "middle"
        
        # Controles cantidad
        ResponsiveBoxLayout:
            orientation: "horizontal"
            size_hint_x: 0.3
            spacing: dp(4)
            
            ResponsiveMDIconButton:
                icon: "minus-circle"
                theme_icon_color: "Custom"
                icon_color: ds_color('error')
                size_hint_x: None
                width: dp(32)
                on_release: root.pedido_screen.decrementar_item(root.item_data)
            
            MDLabel:
                text: str(root.item_cantidad)
                font_style: "H6"
                bold: True
                halign: "center"
                valign: "middle"
                size_hint_x: None
                width: dp(30)
                theme_text_color: "Primary"
            
            ResponsiveMDIconButton:
                icon: "plus-circle"
                theme_icon_color: "Custom"
                icon_color: ds_color('success')
                size_hint_x: None
                width: dp(32)
                on_release: root.pedido_screen.incrementar_item(root.item_data)
        
        # Subtotal
        MDLabel:
            text: f"${root.item_subtotal:.2f}"
            font_style: "Subtitle1"
            bold: True
            size_hint_x: 0.25
            halign: "right"
            valign: "middle"
            theme_text_color: "Custom"
            text_color: ds_color('success')


# ========== ESTADO VAC√çO ==========
<EmptyCartState>:
    orientation: "vertical"
    padding: dp(30)
    spacing: dp(15)
    
    MDLabel:
        text: "üõí"
        font_size: sp(64)
        halign: "center"
        size_hint_y: None
        height: dp(80)
    
    MDLabel:
        text: "Carrito vac√≠o"
        font_style: "H6"
        halign: "center"
        theme_text_color: "Secondary"
        size_hint_y: None
        height: dp(30)
    
    MDLabel:
        text: "Agrega productos para crear un pedido"
        font_style: "Body2"
        halign: "center"
        theme_text_color: "Hint"
        italic: True
        size_hint_y: None
        height: dp(25)